name: å¸å®‰æ¨ç‰¹ç›‘æ§(å¸¦ç¿»è¯‘ç‰ˆ)

on:
  schedule:
    # æ¯ 20 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    - cron: '*/20 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨æµ‹è¯•

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: å‡†å¤‡ç¯å¢ƒ
        uses: actions/checkout@v2

      - name: å®‰è£… Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ– (æ–°å¢ç¿»è¯‘åº“)
        # è¿™é‡Œæˆ‘ä»¬å¤šè£…äº†ä¸€ä¸ª deep-translator ç”¨æ¥åšå…è´¹ç¿»è¯‘
        run: pip install requests feedparser deep-translator

      - name: è¿è¡Œç›‘æ§è„šæœ¬
        env:
          # ã€é‡è¦ã€‘è¯·ä¿ç•™ä½ çš„ Token
          PUSH_TOKEN: "d5f7de478314479bba5bce5b4fb1388b"
          # ã€ç›®æ ‡ã€‘å¦‚æœä½ æƒ³æ¢äººï¼Œæ”¹ä¸‹é¢é“¾æ¥æœ€åçš„ ID å³å¯
          # æ¯”å¦‚æƒ³ç›‘æ§é©¬æ–¯å…‹ï¼Œå°±æ”¹æˆ: .../user/elonmusk
          RSS_URL: "https://rsshub.app/twitter/user/Web3WithBinance"
        run: |
          python -c "
          import feedparser
          import requests
          import os
          import time
          import re
          from deep_translator import GoogleTranslator

          token = os.environ['PUSH_TOKEN']
          rss_url = os.environ['RSS_URL']
          
          print('æ­£åœ¨è¿æ¥æµ·å¤–èŠ‚ç‚¹æ£€æŸ¥æ¨ç‰¹...')
          try:
              feed = feedparser.parse(rss_url)
              if feed.entries:
                  newest = feed.entries[0]
                  
                  # 1. æ—¶é—´åˆ¤æ–­ (åªæ¨é€ 40 åˆ†é’Ÿå†…çš„æ–°é—»)
                  published_time = time.mktime(newest.published_parsed)
                  current_time = time.time()
                  time_diff = current_time - published_time
                  
                  # ä¸ºäº†æ–¹ä¾¿ä½ æµ‹è¯•ï¼Œä½ å¯ä»¥æŠŠä¸‹é¢è¿™ä¸ª < 2400 æ”¹å¤§ä¸€ç‚¹ï¼Œæˆ–è€…å…ˆåˆ æ‰ if é™åˆ¶
                  if time_diff < 2400:
                      print('å‘ç°æ–°æ¨æ–‡ï¼Œæ­£åœ¨ç¿»è¯‘...')
                      
                      # 2. æ¸…ç† HTML æ ‡ç­¾ä»¥ä¾¿ç¿»è¯‘
                      raw_text = newest.description
                      clean_text = re.sub(r'<[^>]+>', '', raw_text) # å»æ‰ <br> <img> ç­‰
                      
                      # 3. è‡ªåŠ¨ç¿»è¯‘ (å¦‚æœç¿»è¯‘å¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åªå‘åŸæ–‡)
                      try:
                          translator = GoogleTranslator(source='auto', target='zh-CN')
                          translated_text = translator.translate(clean_text)
                      except Exception as e:
                          translated_text = f'(ç¿»è¯‘å¤±è´¥: {e})'

                      # 4. ç»„è£…æ¶ˆæ¯
                      title = 'ğŸš¨ å¸å®‰é’±åŒ…æœ‰æ–°åŠ¨æ€ï¼'
                      content = f'''
                      <b>ã€ä¸­æ–‡ç¿»è¯‘ã€‘</b><br>{translated_text}<br>
                      <br><b>ã€è‹±æ–‡åŸæ–‡ã€‘</b><br>{raw_text}<br>
                      <br>ğŸ‘‰ <a href="{newest.link}">ç‚¹å‡»æŸ¥çœ‹åŸæ–‡</a>
                      '''
                      
                      # 5. å‘é€
                      url = 'http://www.pushplus.plus/send'
                      data = {'token': token, 'title': title, 'content': content, 'template': 'html'}
                      requests.post(url, json=data)
                      print('âœ… ç¿»è¯‘å¹¶æ¨é€æˆåŠŸï¼')
                  else:
                      print(f'ğŸ’¤ æœ€æ–°æ¨æ–‡æ˜¯ {time_diff/60:.1f} åˆ†é’Ÿå‰çš„æ—§æ¶ˆæ¯ï¼Œä¸æ‰“æ‰°')
              else:
                  print('âš ï¸ æš‚æ—¶æ²¡æŠ“å–åˆ°å†…å®¹')
          except Exception as e:
              print(f'âŒ è¿è¡Œå‡ºé”™: {e}')
          "
