name: å¼ºåŠ›è°ƒè¯•ç‰ˆ(æ— è§†æ—¶é—´é™åˆ¶)

on:
  workflow_dispatch: # åªèƒ½æ‰‹åŠ¨è§¦å‘ï¼Œç”¨æ¥æŸ¥é”™

jobs:
  debug-monitor:
    runs-on: ubuntu-latest
    steps:
      - name: å‡†å¤‡ç¯å¢ƒ
        uses: actions/checkout@v2

      - name: å®‰è£… Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests feedparser deep-translator

      - name: è¿è¡Œè¯Šæ–­è„šæœ¬
        env:
          PUSH_TOKEN: "d5f7de478314479bba5bce5b4fb1388b"
          # è¿™é‡Œå¡«é‚£ä¸ªæœ€è¿‘ 40 åˆ†é’Ÿå‘è¿‡è´´çš„è´¦å· ID
          RSS_URL: "https://nitter.poast.org/BinanceWallet/rss"
        run: |
          python -c "
          import feedparser
          import requests
          import os
          import time
          import re
          from deep_translator import GoogleTranslator
          from datetime import datetime

          token = os.environ['PUSH_TOKEN']
          rss_url = os.environ['RSS_URL']
          
          print('================ è¯Šæ–­å¼€å§‹ ================')
          print(f'æ­£åœ¨å°è¯•è¿æ¥: {rss_url}')
          
          try:
              # 1. å°è¯•æŠ“å–
              feed = feedparser.parse(rss_url)
              
              # 2. æ£€æŸ¥æœ‰æ²¡æœ‰æŠ“åˆ°ä¸œè¥¿
              entry_count = len(feed.entries)
              print(f'ğŸ” æŠ“å–åˆ°çš„æ¨æ–‡æ•°é‡: {entry_count}')
              
              if entry_count > 0:
                  newest = feed.entries[0]
                  print(f'ğŸ“„ ç¬¬ä¸€æ¡æ¨æ–‡æ ‡é¢˜: {newest.title}')
                  print(f'ğŸ”— é“¾æ¥: {newest.link}')
                  
                  # 3. æ£€æŸ¥æ—¶é—´ï¼ˆä»…æ‰“å°ï¼Œä¸æ‹¦æˆªï¼‰
                  if hasattr(newest, 'published_parsed'):
                      pub_time = time.mktime(newest.published_parsed)
                      time_diff = time.time() - pub_time
                      print(f'â±ï¸ è¿™æ¡æ¨æ–‡å‘å¸ƒäº: {time_diff/60:.1f} åˆ†é’Ÿå‰')
                  else:
                      print('âš ï¸ æ— æ³•è¯»å–æ¨æ–‡æ—¶é—´')

                  # 4. ã€å¼ºåˆ¶å‘é€ã€‘ä¸ç®¡æ—¶é—´å¤šä¹…ï¼Œå¿…é¡»å‘ï¼
                  print('ğŸš€ æ­£åœ¨å°è¯•å¼ºåˆ¶å‘é€å¾®ä¿¡é€šçŸ¥...')
                  
                  # ç¿»è¯‘é€»è¾‘
                  raw_text = newest.description
                  clean_text = re.sub(r'<[^>]+>', '', raw_text)
                  try:
                      translator = GoogleTranslator(source='auto', target='zh-CN')
                      translated_text = translator.translate(clean_text)
                  except Exception as e:
                      translated_text = f'ç¿»è¯‘å¤±è´¥ ({e})'

                  title = 'ğŸ› ï¸ è°ƒè¯•æ¶ˆæ¯ï¼šæ”¶åˆ°äº†å—ï¼Ÿ'
                  content = f'''
                  <b>å¦‚æœæ˜¯æ—§æ¶ˆæ¯ï¼Œè¯´æ˜RSSHubæœ‰ç¼“å­˜æˆ–æ²¡æ›´æ–°ã€‚</b><br>
                  <b>å¦‚æœæ˜¯æ–°æ¶ˆæ¯ï¼Œè¯´æ˜ä¹‹å‰çš„ä»£ç æ—¶é—´åˆ¤æ–­å¤ªä¸¥ã€‚</b><br>
                  ------------------<br>
                  <b>æ¨æ–‡æ—¶é—´:</b> {time_diff/60:.1f} åˆ†é’Ÿå‰<br>
                  <b>ç¿»è¯‘:</b> {translated_text}<br>
                  <b>åŸæ–‡:</b> {raw_text}
                  '''
                  
                  res = requests.post('http://www.pushplus.plus/send', json={'token': token, 'title': title, 'content': content, 'template': 'html'})
                  print(f'âœ… æ¨é€è¯·æ±‚å·²å‘å‡ºï¼ŒæœåŠ¡å™¨å“åº”: {res.text}')
                  
              else:
                  # âš ï¸ å…³é”®ï¼šå¦‚æœæ•°é‡ä¸º 0ï¼Œè¯´æ˜ RSSHub è¢«æ¨ç‰¹å±è”½äº†
                  print('âŒ ä¸¥é‡é—®é¢˜ï¼šRSSHub è¿”å›äº†ç©ºåˆ—è¡¨ï¼')
                  print('å¯èƒ½åŸå› ï¼šæ¨ç‰¹å¼€å¯äº†åçˆ¬è™«ï¼ŒRSSHub çš„å…¬å…±èŠ‚ç‚¹æš‚æ—¶å¤±æ•ˆäº†ã€‚')
                  # æ‰“å°æ›´å¤šè°ƒè¯•ä¿¡æ¯
                  if hasattr(feed, 'feed'):
                      print(f'Feed ä¿¡æ¯: {feed.feed}')
                  
          except Exception as e:
              print(f'âŒ è„šæœ¬å‘ç”Ÿå´©æºƒ: {e}')
          
          print('================ è¯Šæ–­ç»“æŸ ================')
          "
