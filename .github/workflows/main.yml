name: å¸å®‰ç›‘æ§(æœ€ç»ˆé˜²å°ç‰ˆ)

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: å‡†å¤‡ç¯å¢ƒ
        uses: actions/checkout@v2

      - name: å®‰è£… Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests feedparser deep-translator

      - name: è¿è¡Œç›‘æ§è„šæœ¬
        env:
          PUSH_TOKEN: "d5f7de478314479bba5bce5b4fb1388b"
        run: |
          python -c "
          import feedparser
          import requests
          import os
          import time
          import re
          import random
          from deep_translator import GoogleTranslator

          token = os.environ['PUSH_TOKEN']
          
          # === å¤‡ç”¨çº¿è·¯åˆ—è¡¨ (è„šæœ¬ä¼šè‡ªåŠ¨ä¸€ä¸ªä¸ªè¯•) ===
          # è¿™äº›æ˜¯ RSSHub çš„é•œåƒç«™å’Œ Nitter èŠ‚ç‚¹ï¼Œæ··åˆä½¿ç”¨æé«˜æˆåŠŸç‡
          urls = [
              'https://rsshub.rssforever.com/twitter/user/BinanceWallet',
              'https://rsshub.ktachibana.party/twitter/user/BinanceWallet',
              'https://nitter.privacydev.net/BinanceWallet/rss',
              'https://nitter.poast.org/BinanceWallet/rss',
              'https://rsshub.app/twitter/user/BinanceWallet' 
          ]

          # === ä¼ªè£…æˆæµè§ˆå™¨çš„å¤´ä¿¡æ¯ (å…³é”®ï¼) ===
          # ä¹‹å‰å¤±è´¥æ˜¯å› ä¸ºæ²¡æœ‰è¿™ä¸ªï¼Œå¯¹æ–¹çŸ¥é“ä½ æ˜¯æœºå™¨äºº
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.5'
          }

          print('================ å¼€å§‹è½®è¯¢ ================')
          
          success = False
          feed = None
          used_url = ''

          # å¾ªç¯å°è¯•æ¯ä¸€ä¸ªé“¾æ¥
          for url in urls:
              print(f'æ­£åœ¨å°è¯•è¿æ¥çº¿è·¯: {url} ...')
              try:
                  # ä½¿ç”¨ requests å¸¦ä¸Šä¼ªè£…å¤´å»ä¸‹è½½æ•°æ®
                  response = requests.get(url, headers=headers, timeout=15)
                  
                  if response.status_code == 200:
                      # æŠŠä¸‹è½½åˆ°çš„å†…å®¹å–‚ç»™ feedparser
                      feed = feedparser.parse(response.text)
                      if feed.entries:
                          print(f'âœ… æˆåŠŸï¼åœ¨è¯¥çº¿è·¯ä¸ŠæŠ“åˆ°äº† {len(feed.entries)} æ¡æ¨æ–‡')
                          success = True
                          used_url = url
                          break # åªè¦æœ‰ä¸€ä¸ªæˆåŠŸï¼Œå°±è·³å‡ºå¾ªç¯
                      else:
                          print(f'âŒ è¿æ¥æˆåŠŸä½†å†…å®¹ä¸ºç©º (å¯èƒ½æ˜¯åçˆ¬è™«ç”Ÿæ•ˆ)')
                  else:
                      print(f'âŒ ç½‘ç«™æŠ¥é”™: çŠ¶æ€ç  {response.status_code}')
              except Exception as e:
                  print(f'âŒ çº¿è·¯è¿æ¥è¶…æ—¶æˆ–å‡ºé”™: {e}')
              
              print('ä¼‘æ¯ 3 ç§’ï¼Œå°è¯•ä¸‹ä¸€æ¡...')
              time.sleep(3)

          # === å¦‚æœæˆåŠŸæŠ“åˆ°æ•°æ®ï¼Œå¼€å§‹å¤„ç† ===
          if success and feed:
              newest = feed.entries[0]
              
              # æ‰“å°ç¬¬ä¸€æ¡çš„æ—¶é—´ï¼Œæ–¹ä¾¿è°ƒè¯•
              if hasattr(newest, 'published_parsed'):
                  pub_time = time.mktime(newest.published_parsed)
                  time_diff = time.time() - pub_time
                  print(f'â±ï¸ æœ€æ–°æ¨æ–‡å‘å¸ƒäº: {time_diff/60:.1f} åˆ†é’Ÿå‰')
                  
                  # è®¾å®šæ—¶é—´é™åˆ¶ï¼šä¾‹å¦‚åªæ¨ 60 åˆ†é’Ÿå†…çš„ (è°ƒè¯•æ—¶å¯ä»¥æ”¹å¤§)
                  # å¦‚æœä½ æƒ³æµ‹è¯•ï¼ŒæŠŠä¸‹é¢çš„ 3600 æ”¹æˆ 9999999
                  limit_seconds = 3600 
                  
                  if time_diff < limit_seconds:
                      print('ğŸš€ å‘ç°æ–°æ¶ˆæ¯ï¼Œå¼€å§‹ç¿»è¯‘æ¨é€...')
                      
                      # ç¿»è¯‘
                      raw_text = newest.description
                      clean_text = re.sub(r'<[^>]+>', '', raw_text)
                      try:
                          translator = GoogleTranslator(source='auto', target='zh-CN')
                          translated_text = translator.translate(clean_text)
                      except:
                          translated_text = 'ç¿»è¯‘æ¥å£è¶…æ—¶'

                      title = 'ğŸš¨ å¸å®‰é’±åŒ…æ–°æ¨æ–‡ (è‡ªåŠ¨ç›‘æ§)'
                      content = f'''
                      <b>ã€çº¿è·¯ã€‘</b> {used_url}<br>
                      <b>ã€ç¿»è¯‘ã€‘</b><br>{translated_text}<br>
                      <br><b>ã€åŸæ–‡ã€‘</b><br>{raw_text}<br>
                      <br>ğŸ‘‰ <a href=\"{newest.link}\">ç‚¹å‡»æŸ¥çœ‹åŸæ–‡</a>
                      '''
                      
                      requests.post('http://www.pushplus.plus/send', json={'token': token, 'title': title, 'content': content, 'template': 'html'})
                      print('âœ… å¾®ä¿¡æ¨é€æˆåŠŸ')
                  else:
                      print('ğŸ’¤ æ˜¯æ—§æ¶ˆæ¯ï¼Œä¸æ‰“æ‰°')
              else:
                  print('âš ï¸ æ— æ³•è¯»å–æ¨æ–‡æ—¶é—´ï¼Œè·³è¿‡')
          else:
              print('ğŸ˜­ æ‰€æœ‰çº¿è·¯éƒ½å¤±è´¥äº†ã€‚æ¨ç‰¹å¤ªéš¾çˆ¬äº†ï¼')
              # å³ä½¿å¤±è´¥ä¹Ÿå‘ä¸ªå¾®ä¿¡å‘Šè¯‰ä½ ï¼Œå…å¾—ä½ ä»¥ä¸ºè„šæœ¬åäº† (ä»…è°ƒè¯•ç”¨)
              # requests.post('http://www.pushplus.plus/send', json={'token': token, 'title': 'ç›‘æ§å…¨éƒ¨å¤±è´¥', 'content': 'æ‰€æœ‰å¤‡ç”¨çº¿è·¯éƒ½è¢«æ¨ç‰¹æ‹¦æˆªäº†ï¼Œè¯·è¿‡æ®µæ—¶é—´å†è¯•ã€‚'})
          
          print('================ ç»“æŸ ================')
          "
